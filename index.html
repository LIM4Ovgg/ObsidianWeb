<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Visualizador Obsidian Canvas</title>
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #202020;
            color: #fff;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }

        #canvas-inner {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
        }

        .node {
            position: absolute;
            border-radius: 8px;
            padding: 8px;
            background: #2c2c2c;
            color: white;
            text-align: center;
            overflow: hidden;
        }

        .node img {
            max-width: 100%;
            max-height: 100%;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        line {
            stroke: #aaa;
            stroke-width: 2;
            marker-end: url(#arrow);
        }

        header {
            padding: 20px;
            background: #1a1a1a;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        #cy {
            width: 100vw;
            height: 90vh;
            display: block;
        }

        #fileInput {
            margin: 15px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #8e44ad;
            color: white;
            cursor: pointer;
        }

        #fileInput:hover {
            background: #732d91;
        }
    </style>
</head>

<body>
    <header>
        <h1>ðŸ§  Visualizador de Canvas do Obsidian</h1>
        <input type="file" id="fileInput" accept=".canvas">
    </header>
    <div id="canvas-container">
        <div id="canvas-inner">
            <svg id="edges"></svg>
        </div>
    </div>

    <script>
        const cy = cytoscape({
            container: document.getElementById('canvas-container'),
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#8e44ad',
                        'label': 'data(label)',
                        'color': '#fff',
                        'font-size': 12,
                        'text-valign': 'center',
                        'text-halign': 'center'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#aaa',
                        'target-arrow-color': '#aaa',
                        'target-arrow-shape': 'triangle'
                    }
                }
            ],
            layout: {
                name: 'cose',
                animate: true
            }
        });
        const container = document.getElementById("canvas-container");
        const inner = document.getElementById("canvas-inner");
        const edgesSvg = document.getElementById("edges");

        let scale = 1;
        let originX = 0;
        let originY = 0;
        let isPanning = false;
        let startX, startY;

        // Pan com mouse
        container.addEventListener("mousedown", e => {
            isPanning = true;
            startX = e.clientX - originX;
            startY = e.clientY - originY;
            container.style.cursor = "grabbing";
        });

        container.addEventListener("mouseup", () => {
            isPanning = false;
            container.style.cursor = "grab";
        });

        container.addEventListener("mousemove", e => {
            if (!isPanning) return;
            originX = e.clientX - startX;
            originY = e.clientY - startY;
            updateTransform();
        });

        // Zoom com scroll
        container.addEventListener("wheel", e => {
            e.preventDefault();
            const zoomFactor = 1.1;
            const mouseX = e.clientX - container.offsetLeft;
            const mouseY = e.clientY - container.offsetTop;

            if (e.deltaY < 0) {
                // zoom in
                scale *= zoomFactor;
                originX = mouseX - (mouseX - originX) * zoomFactor;
                originY = mouseY - (mouseY - originY) * zoomFactor;
            } else {
                // zoom out
                scale /= zoomFactor;
                originX = mouseX - (mouseX - originX) / zoomFactor;
                originY = mouseY - (mouseY - originY) / zoomFactor;
            }
            updateTransform();
        }, { passive: false });

        function updateTransform() {
            inner.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`;
        }

        // Carregar .canvas
        document.getElementById("fileInput").addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = JSON.parse(e.target.result);

                // Limpa
                inner.querySelectorAll(".node").forEach(el => el.remove());
                edgesSvg.innerHTML = `
          <defs>
            <marker id="arrow" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L0,6 L9,3 z" fill="#aaa"/>
            </marker>
          </defs>
        `;

                const nodes = {};
                data.nodes.forEach(node => {
                    const div = document.createElement("div");
                    div.className = "node";
                    div.style.left = node.x + "px";
                    div.style.top = node.y + "px";
                    div.style.width = node.width + "px";
                    div.style.height = node.height + "px";

                    if (node.type === "text") {
                        div.textContent = node.text;
                    } else if (node.type === "file" && node.file.endsWith(".png")) {
                        const img = document.createElement("img");
                        img.src = node.file;
                        div.appendChild(img);
                    } else {
                        div.textContent = node.id;
                    }

                    inner.appendChild(div);
                    nodes[node.id] = { x: node.x, y: node.y, w: node.width, h: node.height };
                });

                data.edges.forEach(edge => {
                    const from = nodes[edge.fromNode];
                    const to = nodes[edge.toNode];
                    if (from && to) {
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        line.setAttribute("x1", from.x + from.w / 2);
                        line.setAttribute("y1", from.y + from.h / 2);
                        line.setAttribute("x2", to.x + to.w / 2);
                        line.setAttribute("y2", to.y + to.h / 2);
                        edgesSvg.appendChild(line);
                    }
                });

                // Resetar zoom/posiÃ§Ã£o ao carregar
                scale = 1;
                originX = 0;
                originY = 0;
                updateTransform();
            };
            reader.readAsText(file);
        });
    </script>
</body>

</html>